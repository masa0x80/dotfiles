#!/usr/bin/env zsh

set -euo pipefail

() {
  : ${BOOKMARKS_DIR:=$SCRAPBOOK_DIR/bookmarks}
  cd $BOOKMARKS_DIR
  rg_prefix='rg -i --files-with-matches'
  selected="$(
    FZF_DEFAULT_COMMAND="$rg_prefix ''" \
      fzf --sort --preview="[[ ! -z {} ]] && rg --pretty --ignore-case -N {q} {}" \
        --bind=ctrl-u:page-up,ctrl-d:page-down,ctrl-j:preview-down,ctrl-k:preview-up,ctrl-g:toggle-all,ctrl-/:deselect-all,ctrl-q:deselect-all \
        --phony -q "" \
        --bind "ctrl-o:execute-silent: open 'obsidian://open?path=$BOOKMARKS_DIR/{1}'" \
        --bind "change:reload:$rg_prefix {q}" \
        --preview-window="90%:wrap"
  )"

  test -z "$selected" && return

  for f in $(echo $selected); do
    open $(head -n1 $(echo "$f" | cut -d: -f1) | sed -e 's|^# \[.*\](\(.*\)).*|\1|')
  done
}
