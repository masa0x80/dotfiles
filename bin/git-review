#!/usr/bin/env zsh

() {
  local issue_id=${1:-$(git issue-id)}
  if test -n "$issue_id"; then
    git log --graph --grep $issue_id \
        --format="%C(auto)%h%d %s %C(blue)%cr %C(green)%cN" | \
        fzf --tac --ansi --no-sort --tiebreak=index +m \
        --preview 'git show {2}' \
        --bind "alt-y:execute-silent: (printf {} | grep -o '[a-f0-9]\{7\}' | head -1 | tr -d '\n' | pbcopy)" \
        --bind "ctrl-m:execute: (grep -o '[a-f0-9]\{7\}' | head -1 | xargs -I % sh -c 'git show --color=always %') << 'FZF-EOF'
            {}
FZF-EOF"
  else
    commit_hash=$(git log --color=always --format="%C(auto)%h%d %s %C(blue)%cr %C(green)%cN" | fzf --ansi --no-sort --tiebreak=index +m | grep -o '[a-f0-9]\{7\}')
    test -z "$commit_hash" && return

    num=$(git log --pretty="%h" | grep -n "$commit_hash" | cut -d : -f 1)
    git log --reverse -$num \
        --format="%C(auto)%h%d %s %C(blue)%cr %C(green)%cN" | \
        fzf --ansi --no-sort --tiebreak=index +m \
        --preview 'git show {1}' \
        --bind "alt-y:execute-silent: (printf {} | grep -o '[a-f0-9]\{7\}' | head -1 | tr -d '\n' | pbcopy)" \
        --bind "ctrl-m:execute: (grep -o '[a-f0-9]\{7\}' | head -1 | xargs -I % sh -c 'git show --color=always %') << 'FZF-EOF'
            {}
FZF-EOF"
  fi
} "$1"
