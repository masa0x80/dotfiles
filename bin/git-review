#!/usr/bin/env zsh

issue_id=$(git issue-id)
if test -n "$issue_id"; then
  git log --graph --color=always --grep $issue_id \
      --format="%C(auto)%h%d %s %C(blue)%cr %C(green)%cN" | \
      fzf --tac --ansi --no-sort --tiebreak=index +m \
      --bind "ctrl-m:execute: echo {} | grep -o '[a-f0-9]\{7\}' | head -n1 | xargs -I % sh -c 'printf % | pbcopy; git show %'"
else
  commit_hash=$(git log --color=always --format="%C(auto)%h%d %s %C(blue)%cr %C(green)%cN" | fzf --ansi --no-sort --tiebreak=index +m | grep -o '[a-f0-9]\{7\}')
  test -z "$commit_hash" && return

  num=$(git log --pretty="%h" | grep -n "$commit_hash" | cut -d : -f 1)
  git log --color=always --reverse -$num \
      --format="%C(auto)%h%d %s %C(blue)%cr %C(green)%cN" | \
      fzf --ansi --no-sort --tiebreak=index +m \
      --bind "ctrl-m:execute: echo {} | grep -o '[a-f0-9]\{7\}' | head -n1 | xargs -I % sh -c 'printf % | pbcopy; git show %'"
fi
