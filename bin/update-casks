#!/usr/bin/env fish

function update_casks
    set -l LOG /tmp/update-casks.log
    echo '' >$LOG

    set -q caskroom_dir && set caskroom_dir /usr/local/Caskroom
    type brew >/dev/null || return 1
    type fzf >/dev/null || return 1

    set packages (brew cask list | fzf --query "$argv")
    if test -n "$packages"
        brew update | tee $LOG
    end

    for pkg in $packages
        set app_dir $caskroom_dir/$pkg
        set latest_version (brew cask info $pkg | grep "$pkg:" | cut -d ' ' -f 2)
        if not test -d $app_dir/$latest_version
            brew cask reinstall $pkg | tee $LOG
        else
            echo -e "INFO: already updated" | tee $LOG
        end
        done

        if test -n "$packages"
            brew cleanup | tee $LOG
        end
    end
end
update_casks $argv
